name: Daily Critical Portfolio Alerts

on:
  schedule:
    # Run Monday-Friday at 2:00 PM EST (19:00 UTC) - once per day during trading hours
    # Adjust timezone as needed - EST is UTC-5, EDT is UTC-4
    - cron: '0 19 * * 1-5'  # 2 PM EST on weekdays
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-critical-alerts:
    runs-on: ubuntu-latest
    name: Check for Critical Portfolio Actions
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create portfolio.json from secret
        env:
          PORTFOLIO_JSON: ${{ secrets.PORTFOLIO_JSON }}
        run: |
          if [ -n "$PORTFOLIO_JSON" ]; then
            echo "$PORTFOLIO_JSON" > portfolio.json
          else
            echo '{"currency": "USD", "cash": 0, "holdings": [], "last_updated": null, "total_value": 0}' > portfolio.json
            echo "Warning: PORTFOLIO_JSON secret not set. Using empty portfolio."
          fi
      
      - name: Set up email credentials
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
        run: |
          echo "EMAIL_SENDER=$EMAIL_SENDER" >> $GITHUB_ENV
          echo "EMAIL_PASSWORD=$EMAIL_PASSWORD" >> $GITHUB_ENV
          if [ -n "$EMAIL_RECIPIENT" ]; then
            echo "EMAIL_RECIPIENT=$EMAIL_RECIPIENT" >> $GITHUB_ENV
          else
            echo "EMAIL_RECIPIENT=$EMAIL_SENDER" >> $GITHUB_ENV
          fi
      
      - name: Run Portfolio Analysis
        run: |
          echo "üìä Running portfolio analysis..."
          python portfolio_analyzer.py > analysis_output.txt 2>&1 || true
        continue-on-error: true
        
      - name: Run Risk Management Check
        run: |
          echo "üõ°Ô∏è Checking portfolio risk..."
          python -c "from risk_manager import RiskManager; rm = RiskManager(); rm.print_risk_report()" > risk_output.txt 2>&1 || true
        continue-on-error: true
      
      - name: Run Critical Alert Check
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT || secrets.EMAIL_SENDER }}
        run: |
          echo "‚ö†Ô∏è Checking for critical alerts..."
          python critical_alert.py
        continue-on-error: true  # Don't fail workflow if alerts are sent
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: portfolio-analysis-results
          path: |
            portfolio.json
            analysis_output.txt
            risk_output.txt
          retention-days: 7
      
      - name: Display portfolio update reminder
        if: always()
        run: |
          echo "üìù IMPORTANT: Update GitHub Secret"
          echo "=================================="
          echo ""
          echo "The portfolio.json has been updated. To keep GitHub Actions in sync:"
          echo ""
          echo "Option 1 - Automatic (recommended):"
          echo "  Run locally: make update-secret"
          echo ""
          echo "Option 2 - Manual:"
          echo "  1. Download portfolio.json from artifacts above"
          echo "  2. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "  3. Update PORTFOLIO_JSON secret with the new content"
          echo ""
          echo "This ensures critical alerts use your latest portfolio data."


